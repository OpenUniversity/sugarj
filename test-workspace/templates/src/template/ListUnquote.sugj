package template;

import org.sugarj.languages.Stratego;

import template.Core;
import template.ConcreteSyntax;
import template.util.MetaExplode;
import template.util.Strategies;

public sugar ListUnquote { 
  context-free syntax
    ListUnquote -> JavaImportDec
    ListUnquote -> JavaClassBodyDec
    ListUnquote -> JavaBlockStm

  context-free syntax
    "$*{" ListUnquoted "}" -> ListUnquote {cons("FromMetaExpr")}
    StrategoStrategy -> ListUnquoted {cons("ListUnquoted")}

  desugarings
    unquote-desugar

  rules
    unquote-desugar :
      TransBody([Rules([SDefNoArgs("main", body)])]) -> 
      TransBody([Rules([SDefNoArgs("main", Seq(Match(Var(modelvar)), body'))])])
    where
      <oncetd(?ListUnquoted(_))> body;
      modelvar := "this__";
      <topdown(try(list-unquoted-app(|modelvar)))> body => body'

    list-unquoted-app(|modelvar) :
      Op("Cons",[ListUnquoted(strat), xs]) ->
      App(CallNoArgs(SVar("conc")), NoAnnoList(Tuple([strat-app, xs])))
    where strat-app := App(strat, Var(modelvar))
}